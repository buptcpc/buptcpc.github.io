<!DOCTYPE html>
<html>

<head>
  <title>暑期训练！</title>
  <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.1.2/echarts.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@3.5.1/dist/full.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .table-container td:nth-child(-n+3),
    .table-container th:nth-child(-n+3) {
      position: sticky;
      left: 0;
      background: white;
      z-index: 1;
    }
  </style>
</head>

<body>
  <div class="mx-5 my-5">
    <h1 class="text-3xl">2022 Summer Training</h1>
    <h1 class="text-gray-400">表中数据为(排名/题数/得分)，使用 <kbd class="kbd kbd-xs">Shift</kbd> +滚轮左右滑动。</h1>
    <button ></button>
    <div class="overflow-x-auto w-full table-container">
      <table id="table" class="table table-zebra table-pin-rows whitespace-nowrap">
        <tbody id="ranking"></tbody>
      </table>
    </div>
    <div id="chart" style="width: 1000px; height:1000px;" class="mt-10"></div>
  </div>
  <script>
    $.get(
      "/stat.json",
      {},
      function (data) {
        const COUNT = Math.ceil(data.conts.length * 15 / 20);
        let scores = data.scores, arr = [];
        for (let team in scores) {
          let all = scores[team];
          all.sort(function (a, b) {
            return b - a;
          });
          let p = 0, q = 0;
          for (let x of all) {
            p += x;
            ++q;
            if (q == COUNT)
              break;
          }
          arr.push({
            name: team,
            score: p / q
          });
        }
        arr.sort(function (a, b) {
          return b.score - a.score;
        });
        let teamsSorted = [];
        for (let i in arr)
          teamsSorted.push(arr[i].name);

        let selected = {};
        for (let d of data.teams)
          selected[d] = false;
        let myChart = echarts.init(document.getElementById('chart'));
        let option = {
          tooltip: {
            trigger: 'axis'
          },
          legend: {
            data: teamsSorted,
            selected: selected
          },
          grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
          },
          toolbox: {
            feature: {
              saveAsImage: {}
            }
          },
          xAxis: {
            type: 'category',
            boundaryGap: false,
            data: data.conts
          },
          yAxis: {
            type: 'value'
          },
          series: data.data
        };
        myChart.setOption(option);


        const member = {
          "打完去超市买点东西吃": "陈杰祥,刘益铭,谢志宏",
          "三个菜鸟": "杨毅霖,宋健,马骐荣",
          "野鸡大队": "任飞,李知拙,鲍睿钊",
          "来了去了": "杨凯丞,吴昊,叶笑天",
          "鹰之一手": "徐天策,李永琰,袁桦斌",
          "未闻队名": "张颢龄,谢牧航,王若竹",
          "奥特猫": "王智炜,胡诚成,李博识",
          "最佳柴郡": "王骋,顾明礼,尤比佳",
          "逆转结局": "金浩然,游俊轩,邓逸伦",
          "字节御宅族": "曾巍,李远洋,田苗",
          "你们队得过什么奖": "王蕴哲,翁正琰,徐慕政",
          "默认用户名": "王鸣谦,许铎,杨云逸",
          "啊对对队": "曾行周,徐子博,钱文韬",
          "左右魔性穿梭": "臧浩民,王宸宇,李祥荣",
          "再做一道就开摆": "管庆涵,刘昱辉,梁恒珲",
          "六目相对": "谢骞,罗毅锐,崔家瑞",
          "我有起名困难症": "刘洋,杨智杰,张志睿",
          "你说的队": "卢安来,孙伟哲,王冀恒",
          "三只蒟蒻": "王佳禾,区庆亮",
          "未命名-1": "赵瑞霖,李乐杨,张智成",
        };

        let head = `<thead><th></th><th>team</th><th>top${COUNT} avg</td>`;
        for (let i in data.conts) 
          head += `<td>${data.conts[i]}</td>`;
        head += "</thead>";
        let attr = head
        for (let i in arr) {
          let details = "";
          const top = data.scores[arr[i].name].sort((a, b) => b - a).slice(0, COUNT).map(x => x.toFixed(2))
          for (let c of data.conts) {
            const detail = data.teamStats[c][arr[i].name]
            if (detail) {
              const [rank, cnt, score] = data.teamStats[c][arr[i].name].split("/")
              if (top.includes(score)) {
                details += `<td><div class="tooltip" data-tip="第${rank}名，${cnt}题，得分${score}，计入总分">${detail}</div></td>`;
                top.splice(top.indexOf(score), 1);
              } else {
                details += `<td style="color: #a0a0a0;"><div class="tooltip" data-tip="第${rank}名，${cnt}题，得分${score}， 未计入总分">${detail}</div></td>`;
              }
            } else {
              details += `<td>-</td>`;
            }
          }
          attr += `<tr class="hover"><th>${parseInt(i) + 1}</th><th><div class="tooltip" data-tip="${member[arr[i].name]}">${arr[i].name}</div></th><th>${arr[i].score.toFixed(2)}</th>${details}</tr>`;
        }
        attr += head;
        $('#ranking').html(attr);
        $("th").each(function () { 
          if ($(this).index() == 1) {
            $(this).css("left", $("th").eq(0).outerWidth(true));
          } else if ($(this).index() == 2) {
            $(this).css("left", $("th").eq(0).outerWidth(true) + $("th").eq(1).outerWidth(true));
          }
        });
      },
      "json"
    );
  </script>

</body>


</html>